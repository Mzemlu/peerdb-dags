–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å,—Ç.–∫ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –î–∞–≥ –Ω–µ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–≤ —á—ë–º-—Ç–æ –æ—à–∏–±–∫–∞)
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: http://air.ddxfitness.ru:8080/dags/mobile_events_update/grid

–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ –≥–∏—Ç–µ pg_mobile_events_update
–∑–∞–ª–∏—Ç—å —Ç—É–¥–∞ SQL:
update_mobile_events.sql
update_mobile_stories.sql
bi_mobile_users.sql
tracker_users.sql

–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è update_mobile_events.sql:
ddxfitness_prod_v2.bi_all_mobile_events (–ø–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–∞ PeerDB, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫ –ª–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞)
ddxfitness_prod_v2.pg_user_payment_plans
ddxfitness_prod_v2.pg_payment_plans
ddxfitness_prod_v2.pg_users
ddxfitness_prod_v2.pg_clubs
ddxfitness_prod_v2.d_inflow_payment_plans

–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è update_mobile_stories.sql:
ddxfitness_prod_v2.bi_mobile_stories (–ø–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–∞ PeerDB, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫ –ª–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞)
ddxfitness_prod_v2.bi_all_mobile_events (–ø–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–∞ PeerDB, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫ –ª–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞)
ddxfitness_prod_v2.pg_story_slides

–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è bi_mobile_users.sql:
ddxfitness_prod_v2.bi_all_mobile_events (–ø–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–∞ PeerDB, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫ –ª–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞)
ddxfitness_prod_v2.bi_mobile_users (–ø–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–∞ PeerDB, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫ –ª–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞)

–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è tracker_users.sql:
ddxfitness_prod_v2.bi_mobile_users
ddxfitness_prod_v2.bi_adv_users
mobile_db.postbacks_all	(–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—É–¥–µ—Ç –ª–∏ –ø–µ—Ä–µ–Ω–æ—Å –≤ ddxfitness_prod_v2, –µ—Å–ª–∏ –¥–∞ - —Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ –Ω–∞ ddxfitness_prod_v2.postbacks_all)

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–∏—Ö
üì§update_mobile_events.sql
–ó–∞–ø–∏—Å—å –≤:
ddxfitness_prod_v2.bi_all_mobile_events

üì§update_mobile_stories.sql
–ó–∞–ø–∏—Å—å –≤:
ddxfitness_prod_v2.bi_mobile_stories

üì§bi_mobile_users.sql
–ó–∞–ø–∏—Å—å –≤:
ddxfitness_prod_v2.bi_mobile_users

üì§ tracker_users.sql
–ó–∞–ø–∏—Å—å –≤:
ddxfitness_prod_v2.bi_adv_users


-- ddxfitness_prod_v2.bi_all_mobile_events –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

CREATE TABLE ddxfitness_prod_v2.bi_all_mobile_events
(

    `device_id` String,

    `user_id` Int64,

    `event_date` Date,

    `event_datetime` DateTime,

    `receive_date` Date,

    `os_name` String,

    `event_name` String,

    `event_params` String,

    `sex` Nullable(String),

    `name` String,

    `last_name` Nullable(String),

    `phone` Nullable(String),

    `email` String,

    `birthday` Nullable(Date),

    `sport_experience` Nullable(String),

    `home_club_id` Nullable(Int64),

    `club_name` String,

    `payment_plan_name` String,

    `status` Nullable(String),

    `start_date` Date,

    `end_date` Date,

    `user_payment_plan_id` Int64,

    `updated_at` DateTime64(3)
)
ENGINE = ReplacingMergeTree
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_name,
 event_datetime,
 device_id)
SETTINGS index_granularity = 8192;

-- ddxfitness_prod_v2.bi_mobile_stories –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

CREATE TABLE ddxfitness_prod_v2.bi_mobile_stories
(

    `device_id` String,

    `event_date` Date,

    `event_datetime` DateTime,

    `receive_date` Date,

    `os_name` String,

    `event_name` String,

    `story_id` Nullable(UInt32),

    `slide_id` Nullable(UInt32),

    `header` String,

    `showtime` Nullable(UInt16),

    `user_id` Int64,

    `sex` Nullable(String),

    `name` String,

    `last_name` Nullable(String),

    `phone` Nullable(String),

    `email` String,

    `birthday` Nullable(Date),

    `sport_experience` Nullable(String),

    `club_name` String,

    `payment_plan_name` String,

    `status` Nullable(String),

    `user_payment_plan_id` Int64,

    `updated_at` DateTime64(3)
)
ENGINE = MergeTree
ORDER BY (event_date,
 event_name,
 device_id)
SETTINGS index_granularity = 8192;


-- ddxfitness_prod_v2.bi_mobile_users –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

CREATE TABLE ddxfitness_prod_v2.bi_mobile_users
(

    `device_id` String,

    `user_id` Int64,

    `min_event_date` Date,

    `max_event_date` Date
)
ENGINE = MergeTree
ORDER BY (min_event_date,
 max_event_date)
SETTINGS index_granularity = 8192;



-- ddxfitness_prod_v2.bi_adv_users –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

CREATE TABLE ddxfitness_prod_v2.bi_adv_users
(

    `click_date` Date,

    `device_id` String,

    `user_id` Int64
)
ENGINE = MergeTree
ORDER BY user_id
SETTINGS index_granularity = 8192;
